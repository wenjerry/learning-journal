# 1.BA：

在结构光三维重建（Structure-from-Motion, SfM）领域，**BA（Bundle Adjustment）** 指的是**光束法平差**，它是一种通过**非线性优化**同时调整三维点云和相机参数的算法。以下是关键解析：

------

### **1. 核心原理**

- **输入**：多视图中匹配的2D特征点（如SIFT、ORB）及其初始3D坐标、相机位姿（旋转矩阵R、平移向量t）和内参（焦距、畸变等）。

- **优化目标**：最小化**重投影误差**（Reprojection Error），即3D点投影到各相机成像平面的位置与实际观测特征点位置的差值（式1）：
  $$
  \min_{\mathbf{P}_i, \mathbf{X}_j} \sum_{i,j} \| \pi(\mathbf{P}_i, \mathbf{X}_j) - \mathbf{x}_{ij} \|^2 
  $$
  其中：

  - $$
    \mathbf{P}_i：第i个相机的投影矩阵（包含R、t）
    $$

  - 
    $$
    \mathbf{X}_j ：第j个3D点坐标
    $$

  - $$
    \pi(\cdot)：相机投影函数（包含内参）
    $$

    

  - $$
    \mathbf{x}_{ij} ：第j个点在i相机中的实际观测坐标。
    $$

    

------

### **2. 技术实现**

- **数学工具**：通常采用 **Levenberg-Marquardt（L-M）算法**（结合高斯牛顿法和梯度下降）求解非线性最小二乘问题[4][58]。
- **加速技巧**：
  - **稀疏性利用**：通过Schur补消元（边缘化3D点变量），将Hessian矩阵分解为相机部分和点云部分，大幅降低计算量（复杂度从O(n³)降至O(m³)，m≪n）[58]。
  - **增量式BA**（iBA）：仅优化受新视图影响的部分参数（如COLMAP中的局部BA）[1][62]。

------

### **3. 在SfM中的作用**

- **全局BA**：在完整重建后执行，消除累积误差（如漂移问题）。
- **局部BA**：在增量式SfM中每添加一个关键帧后运行，实时优化局部区域（如相邻5-10帧）[1][4.4节]。
- **鲁棒性增强**：结合离群点剔除（如RANSAC）和加权损失函数（Huber核），抑制错误匹配的影响[3]。

------

### **4. 性能挑战与改进**

- **计算瓶颈**：传统BA对超大规模数据（如城市级照片集）仍显吃力。
- **现代解决方案**：
  - **分布式BA**：如Wu et al. (2011)提出的多机并行求解[63]。
  - **位姿图优化**（Pose Graph Optimization）：先仅优化相机位姿，再三角化3D点，牺牲部分精度换取速度[7]。

------

# 2.L-M算法：

通过动态调整**阻尼因子（Damping Parameter）** $\lambda$ 来平衡两种策略：

- **高斯牛顿法（GN）**：在局部近似为二次函数时快速收敛（但Hessian矩阵 $\mathbf{J}^T\mathbf{J}$ 可能病态）。
- **梯度下降法（GD）**：在远离最优解时更稳健（但收敛慢）。
   **参数更新方程**：

$$
(\mathbf{J}^T\mathbf{J} + \lambda \operatorname{diag}(\mathbf{J}^T\mathbf{J})) \Delta \theta = -\mathbf{J}^T \mathbf{r} 
$$

其中：

- $$
  \mathbf{J}
  $$

  是残差对参数的雅可比矩阵
- $$
  \lambda
  $$

  越大，更新步长 $\Delta \theta$ 越接近GD方向；$\lambda$ 越小，越接近GN方向。

# 3.场景图增强：

**场景图增强（Scene Graph Augmentation）**通俗来说，就是在一堆照片中，通过更智能的方法识别和分类图像之间的几何关系，从而让后续的3D重建更稳、更准、更快。
具体来说，它的核心思路是通过**多模型几何验证**来解决以下问题：
1. **剔除干扰项**：比如照片上的水印、时间戳（WTFs）[60]，它们会错误地连接不同场景的照片。增强后的场景图能自动过滤这些无效匹配。
2. **分类场景类型**：通过分析图像对之间的几何变换（比如单应性矩阵H、基本矩阵F），区分平面场景（如墙面）、全景（纯旋转拍摄）和一般3D场景[1][3]。比如两张拍墙的照片会被标记为“平面”，避免后续错误三角化。
3. **提升初始重建质量**：只选择几何关系明确的图像对（如非全景、已标定的）作为重建起点，减少“开局翻车”的概率[3]。
举个栗子 🌰：
- 假设你用手机拍了10张埃菲尔铁塔的照片，其中3张带了水印，2张是全景模式旋转拍摄。
- 场景图增强会：
  - 把带水印的3对匹配直接扔掉（防误连）；
  - 标记全景照片对为“纯旋转”，防止生成飘在空中的错误3D点；
  - 优先用清晰、正常拍摄的5张照片开始重建。
  **效果**：在Schonberger和Frahm(2016)[1]的实验中，这个方法让重建成功率（注册图像数量）平均提升了23%，特别是在Rome数据集上多恢复了7,000多张照片的3D信息[1][表1]。

# 4.RANSAC——有点像聚类分析

### **RANSAC（随机抽样一致）——"投票式"的离群点过滤器**
（🍀 **核心思想**：用"少数服从多数"的方式找出靠谱的数据）

---

#### 🧩 **举个生活例子**
假设你在一堆硬币里**找真币**：
1. **乱抓一把**：随机抓5枚硬币（假设其中3真2假）
2. **量尺寸**：发现多数硬币直径≈24mm（真币标准）
3. **投票确认**：把所有硬币过筛，留下符合24mm的——**这就是一次RANSAC迭代**
4. **重复抽签**：如果某次抓的5枚全是假币？扔掉重来！直到找到**最大共识组**

---

### 📸 **在视觉中的应用（如特征匹配）**
| 步骤            | 操作                                   | 类比               |
| --------------- | -------------------------------------- | ------------------ |
| **1. 随机抽样** | 从100对匹配点中随机选4对               | 随机抓4枚硬币      |
| **2. 拟合模型** | 用这4对点计算基础矩阵F                 | 测量4枚硬币直径    |
| **3. 统计内点** | 统计有多少其他点符合这个F（误差<阈值） | 数多少硬币符合24mm |
| **4. 保留最优** | 记录内点最多的模型，重复N次            | 留下最多的真币组合 |


---

### ⚡ **关键优势**
- **抗干扰能力**：即使80%数据是噪声（如误匹配），也能找到正确模型
- **自适应阈值**：通过迭代自动调整"内点"判定标准（类似动态调整硬币公差）

---

### 🛠️ **COLMAP中的实战改进 [1]**
1. **多模型验证**：同时检验**单应性H**和**基础矩阵F**，避免把墙面误判为3D场景
2. **提前终止**：若某次迭代内点比例>95%，立即停止（省时）
3. **PROSAC优化**：优先检验高置信度匹配点（类似先检查最像真币的）

---

**❗ 注意**：RANSAC可能会**漏检正确但小众的模型**（比如真实的稀有硬币会被当成噪声）—— 这正是后续改进算法（如MLESAC）要解决的问题 [1][6]。

# 5.colmap使用教程

## 详细操作教程（GUI 图形界面版）

假设你已经下载并解压了 `south-building.zip`，并将图片放在了 `images/` 文件夹内。

### 1. 创建项目

1. 启动 `COLMAP.bat`。
2. 点击 **File** -> **New Project**。
3. 在 `Database` 处点击 `New`，新建一个 `.db` 文件（例如 `south_build.db`）。
4. 在 `Images path` 处点击 `Select`，指向你的 `images` 文件夹。
5. 点击 **Save**。

### 2. 特征提取 (Feature Extraction)

- 点击 **Reconstruction** -> **Feature extraction**。
- **参数建议：** 默认即可（通常使用 `SIFT` 算法）。如果你的图片是鱼眼镜头拍摄的，记得在 `Camera model` 里选 `OPENCV_FISHEYE`。
- 点击 **Extract**。

### 3. 特征匹配 (Feature Matching)

- 点击 **Reconstruction** -> **Feature matching**。
- **参数建议：** 对于 200 张以内的图，选 `Exhaustive` (穷举匹配) 效果最好。
- 点击 **Run**。

### 4. 稀疏重建 (Sparse Reconstruction) —— 最关键的一步

- 点击 **Reconstruction** -> **Start reconstruction**。
- 此时你会看到屏幕上开始出现一个个红色的相机位姿和白色的点云。
- **结果检查：** 重建完成后，你可以用鼠标拖动查看点云，确认建筑轮廓是否清晰。

### 5. 稠密重建 (Dense Reconstruction)

如果你想生成像模型一样的“厚实”点云：

1. 点击 **Reconstruction** -> **Dense reconstruction**。
2. 创建一个新的文件夹作为 `Workspace`。
3. 依次点击：**Undistortion** (去畸变) -> **Stereo** (立体匹配，最耗时) -> **Fusion** (融合)。
4. 完成后，在文件夹里找到 `fused.ply`，用 MeshLab 打开查看。

# 6.南楼实验结果

![2503dd40be258c354a215efe0328e4de](/Users/wengjinrui/Library/Containers/com.tencent.xinWeChat/Data/Documents/xwechat_files/wxid_9s7ra5oj3g1321_ba38/temp/RWTemp/2026-01/2503dd40be258c354a215efe0328e4de.png)

图一.数据集以及稀疏重建结果

![c5c3f53afae4c4103e35fbb053a9500d](/Users/wengjinrui/Library/Containers/com.tencent.xinWeChat/Data/Documents/xwechat_files/wxid_9s7ra5oj3g1321_ba38/temp/RWTemp/2026-01/c5c3f53afae4c4103e35fbb053a9500d.png)

图二.colmap稠密重建效果